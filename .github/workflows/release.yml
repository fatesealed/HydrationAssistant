name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Resolve version from tag
        id: vars
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Run tests
        run: swift test

      - name: Build release binary
        run: swift build -c release --product HydrationAssistantApp

      - name: Package app and pkg
        id: package
        shell: bash
        run: |
          set -euo pipefail

          APP_NAME="HydrationAssistant"
          EXEC_NAME="HydrationAssistantApp"
          BUNDLE_ID="com.wangzhishan.hydrationassistant"
          VERSION="${{ steps.vars.outputs.version }}"

          OUT_DIR="$RUNNER_TEMP/release"
          APP_DIR="$OUT_DIR/${APP_NAME}.app"
          ROOT_DIR="$OUT_DIR/pkgroot-fixed"
          PLIST="$OUT_DIR/component.plist"
          PKG="$OUT_DIR/${APP_NAME}-${VERSION}.pkg"

          rm -rf "$OUT_DIR"
          mkdir -p "$APP_DIR/Contents/MacOS"

          cp ".build/release/${EXEC_NAME}" "$APP_DIR/Contents/MacOS/${EXEC_NAME}"
          chmod +x "$APP_DIR/Contents/MacOS/${EXEC_NAME}"

          cat > "$APP_DIR/Contents/Info.plist" <<PLIST_EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
          <key>CFBundleDevelopmentRegion</key><string>en</string>
          <key>CFBundleExecutable</key><string>${EXEC_NAME}</string>
          <key>CFBundleIdentifier</key><string>${BUNDLE_ID}</string>
          <key>CFBundleInfoDictionaryVersion</key><string>6.0</string>
          <key>CFBundleName</key><string>${APP_NAME}</string>
          <key>CFBundlePackageType</key><string>APPL</string>
          <key>CFBundleShortVersionString</key><string>${VERSION}</string>
          <key>CFBundleVersion</key><string>${VERSION}</string>
          <key>LSMinimumSystemVersion</key><string>14.0</string>
          <key>LSUIElement</key><true/>
          <key>NSPrincipalClass</key><string>NSApplication</string>
          </dict></plist>
          PLIST_EOF

          codesign --force --deep --sign - "$APP_DIR"

          mkdir -p "$ROOT_DIR/Applications"
          cp -R "$APP_DIR" "$ROOT_DIR/Applications/"

          pkgbuild --analyze --root "$ROOT_DIR" "$PLIST"
          /usr/libexec/PlistBuddy -c "Set :0:BundleIsRelocatable false" "$PLIST"
          /usr/libexec/PlistBuddy -c "Set :0:BundleIsVersionChecked true" "$PLIST"

          pkgbuild \
            --root "$ROOT_DIR" \
            --component-plist "$PLIST" \
            --identifier "$BUNDLE_ID" \
            --version "$VERSION" \
            --install-location / \
            "$PKG"

          APP_ZIP="$OUT_DIR/${APP_NAME}-${VERSION}.zip"
          ditto -c -k --sequesterRsrc --keepParent "$APP_DIR" "$APP_ZIP"

          echo "pkg_path=$PKG" >> "$GITHUB_OUTPUT"
          echo "zip_path=$APP_ZIP" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          generate_release_notes: true
          files: |
            ${{ steps.package.outputs.pkg_path }}
            ${{ steps.package.outputs.zip_path }}
