# 喝水小助手（macOS）设计文档

- 日期：2026-02-07
- 状态：已确认
- 目标平台：macOS
- UI 形态：菜单栏常驻（MenuBarExtra）+ 设置窗口

## 1. 背景与目标

本项目从零开始构建一个适用于 macOS 的喝水小助手，核心目标是：

1. 在工作时段内帮助用户喝够当日目标水量。
2. 将提醒分为两类：`该喝水了`（时间驱动）和 `该接水了`（杯量驱动）。
3. 保持操作成本低：尽量一键记录，不打断工作流。
4. 使用可爱、正反馈的视觉设计提升坚持度。

## 2. 已确认需求

1. 应用形态：菜单栏 + 可打开设置窗口。
2. 每日目标计算：按体重公式自动计算（性别和年龄用于轻量修正）。
3. 提醒策略：固定规则。
4. 提醒范围：仅上班时段内有效；下班后不提醒。
5. 记录方式：一键记录 `喝了半杯/一杯`。
6. 提醒渠道：macOS 通知 + 菜单栏图标状态变化。
7. 视觉风格：小动物养成风。
8. 技术栈：SwiftUI + MenuBarExtra（原生 macOS）。
9. 午休策略：支持午休免打扰（例如 12:00-13:30）。

## 3. 方案对比与选型

### 3.1 备选方案

1. 方案 A（选中）：本地优先 MVP。
2. 方案 B：规则引擎增强版（多场景配置）。
3. 方案 C：智能自适应版（动态提醒频率）。

### 3.2 选型结论

首版采用方案 A。理由：

1. 与当前目标最匹配，开发路径最短。
2. 原生体验稳定，通知与菜单栏集成最好。
3. 规则透明，易调试、易解释、可快速迭代。

## 4. 功能设计

### 4.1 首版必须功能（M1）

1. 基础资料设置：体重、性别、年龄、杯子容量。
2. 时间设置：上班时间、下班时间、午休免打扰区间。
3. 今日面板：
   - 今日目标（ml）
   - 已喝（ml）
   - 达标率
   - 下一次喝水提醒倒计时
   - 杯中估算余量
4. 快速操作：
   - 喝了半杯
   - 喝了一杯
   - 已接满
   - 稍后提醒
5. 双提醒系统：
   - 该喝水了（按时间）
   - 该接水了（按余量）
6. 下班后停提醒；跨日自动结算。

### 4.2 你提出且建议纳入的增强功能

1. 可配置提醒强度：仅通知 / 通知+音效（默认仅通知）。
2. 每日复盘卡片：展示达标情况、提醒次数、响应率。
3. 忽略保护：连续多次忽略时，自动降低打扰频率并在菜单栏显示温和提示。
4. 补水提示语模板：文案可切换（可爱/中性）。
5. 工作日模板：周一到周五可共享时间策略，后续可扩展单日覆盖。
6. 小动物状态系统：开心/普通/口渴三态与达标率绑定。

## 5. 规则设计

### 5.1 每日目标计算

- 基础公式：`baseMl = weightKg * K`
- `K` 为可配置默认系数（首版给默认值，可在设置页高级选项中修改）。
- 性别、年龄仅做小范围修正，不作为硬性医学建议。
- 最终目标定义为“工作时段内需要完成的目标量”。

### 5.2 该喝水了（时间提醒）

触发条件：

1. 当前时间处于上班到下班区间内。
2. 当前不在午休免打扰区间。
3. 今日未达成目标。

计算方式：

- 根据“剩余目标量 / 剩余有效时段”得到下一次提醒间隔。
- 点击 `稍后提醒` 后顺延固定分钟数。

### 5.3 该接水了（杯量提醒）

触发条件：

- `cupRemainingMl <= cupCapacityMl * threshold`

说明：

- `threshold` 默认可设为 20%。
- 用户点击 `已接满` 后将杯中余量重置为杯容量。

### 5.4 行为记录与状态更新

- 点击 `喝了半杯/一杯`：
  1. 写入一条 `DrinkLog`
  2. 增加今日已喝量
  3. 扣减杯中余量
- 跨日处理：
  1. 归档昨日数据
  2. 创建新 `DailyPlan`
  3. 重置杯状态并保留用户配置

## 6. 数据模型（SwiftData）

1. `UserProfile`
   - `weightKg`
   - `gender`
   - `age`
   - `cupCapacityMl`
2. `WorkSchedule`
   - `workStart`
   - `workEnd`
   - `lunchStart`
   - `lunchEnd`
3. `DailyPlan`
   - `date`
   - `targetMl`
   - `consumedMl`
   - `isGoalReached`
4. `DrinkLog`
   - `timestamp`
   - `amountMl`
   - `source`（manual/quick-action）
5. `CupState`
   - `remainingMl`
   - `lastRefillAt`

## 7. 架构设计

### 7.1 分层

1. UI Layer
   - 菜单栏视图
   - 设置窗口
   - 今日面板
2. Domain Layer
   - `HydrationService`
   - `GoalCalculator`
   - `ReminderScheduler`
3. Data Layer
   - SwiftData Repository

### 7.2 关键组件

1. `NotificationManager`
   - 统一封装系统通知
2. `DayBoundaryHandler`
   - 负责跨日结算与数据轮转
3. `AppStateStore`
   - 聚合当日状态，驱动 UI 刷新

## 8. 错误处理与降级策略

1. 首次未配置完整资料：显示引导态，不启动提醒。
2. 通知权限被拒绝：降级为菜单栏状态提示。
3. 应用异常退出后重启：通过当日 `DrinkLog` 重建状态。
4. 系统时间/时区变化：强制重算下一次提醒。

## 9. 测试策略

1. 单元测试
   - 目标计算
   - 提醒间隔
   - 上班/下班/午休边界
2. 集成测试
   - 快捷记录 -> 数据层 -> UI 状态联动
3. 手工验收
   - 完整工作日流程（上班、午休、下班、跨日）

## 10. 里程碑

1. M1（核心可用）
   - 配置、记录、双提醒、时段控制、跨日结算
2. M2（体验增强）
   - 小动物状态反馈、每日复盘、文案模板
3. M3（优化）
   - 参数调优、规则可配置化、后续智能化预留

## 11. 非目标（首版暂不做）

1. 云同步与多设备共享
2. Apple Watch / iPhone 联动
3. 智能硬件自动读取（杯垫、水杯传感器）

## 12. 验收标准

1. 用户完成初始化后，可在菜单栏完成全部高频操作。
2. 仅在上班且非午休时段收到提醒。
3. 能清晰区分 `该喝水了` 与 `该接水了`。
4. 当日进度和目标计算可解释、可追溯。
5. 一天使用后能看到明确达标结果与正反馈。
